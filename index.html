<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HACCP SYSTEM</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230A84FF'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-weight='bold'>H</text></svg>">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- BARRA CLOUD UTENTE (sempre visibile) -->
<div id="cloud-user-bar" style="display: none; position: fixed; background: linear-gradient(135deg, #0A84FF 0%, #0066CC 100%); color: white; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-size: 12px; display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 16px;">‚òÅÔ∏è</span>
        <div>
            <strong id="cloud-username-display">---</strong>
            <small id="cloud-sync-status" style="display: block; opacity: 0.8; font-size: 11px;">Sincronizzato</small>
        </div>
    </div>
    <button onclick="effettuaLogout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600;">
        üö™ ESCI
    </button>
</div>

<!-- MODAL SELEZIONE INGREDIENTI -->
<div id="modal-seleziona-ingredienti" class="modal-overlay" style="display:none;">
    <div class="modal-card is-green">
        <h3 class="modal-title is-green">‚úÖ SELEZIONA INGREDIENTI</h3>
        <div id="lista-ingredienti-selezione" class="modal-list"></div>
        <div class="modal-actions">
            <button type="button" class="modal-btn is-success" onclick="confermaSelezioneIngredienti()">
                ‚úÖ CONFERMA SELEZIONE
            </button>
            <button type="button" class="modal-btn is-secondary" onclick="chiudiModalSelezionaIngredienti()">
                ‚ùå ANNULLA
            </button>
        </div>
    </div>
</div>

<!-- MODAL CHECKLIST GUIDATE -->
<div id="modal-checklist" class="modal-overlay" style="display:none;">
    <div class="modal-card">
        <h3 id="checklist-title" class="modal-title">Checklist</h3>
        <div id="checklist-items" class="modal-list"></div>
        <div class="modal-actions">
            <button type="button" id="checklist-confirm" class="modal-btn is-success">Conferma</button>
            <button type="button" onclick="chiudiChecklistModal()" class="modal-btn is-secondary">Annulla</button>
        </div>
    </div>
</div>

<!-- LOGIN -->
<section id="sez-login" class="schermata">
    <div class="card-centrale">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
            <h1 style="margin:0;">HACCP SYSTEM</h1>
            <button type="button" onclick="entraAdminDirect()" title="Admin" style="background:#1f1f1f; border:1px solid #333; border-radius:8px; width:38px; height:38px; display:flex; align-items:center; justify-content:center; font-size:18px;">‚öôÔ∏è</button>
        </div>
        <p>Seleziona operatore</p>
        <div id="lista-utenti-login" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:10px; margin-top:10px;"></div>
    </div>
</section>

<!-- ADMIN - AUDIT LOG -->
<section id="sez-admin-audit" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h3>üßæ AUDIT LOG</h3>
    </div>

    <div class="contenuto" style="max-width: 900px; margin: 0 auto;">
        <div class="audit-toolbar">
            <input type="text" id="audit-filter" placeholder="Cerca (utente, azione, sezione...)" />
            <select id="audit-limit">
                <option value="50">Ultimi 50</option>
                <option value="100">Ultimi 100</option>
                <option value="200" selected>Ultimi 200</option>
                <option value="500">Ultimi 500</option>
            </select>
            <button type="button" onclick="caricaAuditLog()">üîÑ Aggiorna</button>
        </div>

        <div id="audit-list" class="audit-list"></div>
    </div>
</section>

<!-- ADMIN - FIRMA DIGITALE -->
<section id="sez-admin-firma" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h3>‚úçÔ∏è FIRMA DIGITALE</h3>
    </div>

    <div class="contenuto">
        <div class="card-centrale signature-card">
            <p class="signature-help">Disegna la tua firma con il mouse o il dito.</p>
            <canvas id="signature-canvas" class="signature-canvas"></canvas>

            <div class="signature-actions">
                <button type="button" onclick="clearSignatureCanvas()" class="signature-btn secondary">Cancella</button>
                <button type="button" onclick="saveSignatureCanvas()" class="signature-btn primary">Salva firma</button>
            </div>

            <div class="signature-preview" id="signature-preview" style="display:none;">
                <p>Anteprima firma salvata:</p>
                <img id="signature-preview-img" alt="Firma" />
            </div>
        </div>
    </div>
</section>

<button type="button" id="temp-nc-trigger" class="temp-nc-trigger-icon" onclick="apriTempNcManuale()" aria-label="Gestisci anomalie">‚ö†Ô∏è</button>

<!-- ADMIN - GESTIONE UTENTI -->
<section id="sez-admin-utenti" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h3>GESTIONE COLLABORATORI</h3>
    </div>

    <div class="card-centrale">
        <p>Registra Nuovo Collaboratore</p>
        <label for="nuovo-nome-utente" style="position: absolute; left: -9999px;">Nome e Cognome</label>
        <input type="text" id="nuovo-nome-utente" placeholder="Nome e Cognome">
        <div style="margin: 15px 0; text-align: left; color: white; background: #333; padding: 10px; border-radius: 5px;">
            <p style="font-size: 0.8rem; margin-bottom: 5px; color: gold;">Ruolo Aziendale:</p>
            <label><input type="radio" name="ruolo-utente" value="Operatore" checked> Operatore</label><br>
            <label><input type="radio" name="ruolo-utente" value="Responsabile"> Responsabile Autocontrollo</label>
        </div>

        <button onclick="aggiungiUtente()">REGISTRA UTENTE</button>
    </div>

    <div id="lista-utenti-creati" class="elenco-dati"></div>
</section>

<!-- ADMIN - GESTIONE FRIGORIFERI -->
<section id="sez-admin-frigo" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h3>CONFIGURAZIONE FRIGORIFERI</h3>
    </div>

    <div class="card-centrale">
        <p>Aggiungi un nuovo frigo</p>
        <label for="nuovo-nome-frigo" style="position: absolute; left: -9999px;">Nome frigorifero</label>
        <input type="text" id="nuovo-nome-frigo" placeholder="NOME FRIGO (es. Frigo Pesce)">

        <div style="margin: 15px 0;">
            <label><input type="radio" name="tipo-frigo" value="Positivo" checked> üü¢ Positivo (+4¬∞C)</label><br>
            <label><input type="radio" name="tipo-frigo" value="Negativo"> ‚ùÑÔ∏è Negativo (-18¬∞C)</label>
        </div>
        
        <button onclick="aggiungiFrigo()">AGGIUNGI MACCHINA</button>
    </div>
   
    <div id="lista-frigo-creati" class="elenco-dati"></div>
</section>

<!-- ADMIN - CONFIGURAZIONE PEC -->
<section id="sez-admin-pec" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h3>üìß CONFIGURAZIONE PEC</h3>
    </div>

    <div class="contenuto" style="max-width: 900px; margin: 0 auto;">
        <div style="background:#1a1a1a; padding:20px; border-radius:10px; margin-bottom:20px;">
            <h4 style="margin:0 0 15px 0; color:#4CAF50;">Account PEC Configurati</h4>
            <div id="lista-pec-accounts" style="margin-bottom: 15px;">
                <!-- Lista generata dinamicamente -->
            </div>
            <button type="button" onclick="aggiungiAccountPEC()" style="width:100%; padding:12px; font-size:15px; background:#4CAF50;">
                ‚ûï AGGIUNGI ACCOUNT PEC
            </button>
        </div>

        <div style="background:#1a1a1a; padding:20px; border-radius:10px; margin-bottom:20px;">
            <h4 style="margin:0 0 15px 0; color:#FF9800;">ü§ñ Scansione Automatica</h4>
            <div id="stato-autoscan" style="font-size:13px; margin-bottom:12px; color:#888; padding:10px; background:#0a0a0a; border-radius:5px;">
                üî¥ <strong>DISATTIVO</strong> - Scansione manuale
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button id="btn-toggle-autoscan" type="button" onclick="toggleScansionePECAutomatica()" style="padding:10px; font-size:14px; background:#4CAF50;">
                    ‚ñ∂Ô∏è ATTIVA AUTO-SCAN
                </button>
                <button type="button" onclick="cambiaIntervalloScansione()" style="padding:10px; font-size:14px; background:#FF9800;">
                    ‚è±Ô∏è INTERVALLO
                </button>
            </div>
        </div>

        <div style="background:#1a1a1a; padding:20px; border-radius:10px; margin-bottom:20px;">
            <h4 style="margin:0 0 15px 0; color:#2196F3;">üì• Scansione Manuale</h4>
            <div id="log-pec" style="background:#0a0a0a; padding:12px; border-radius:5px; max-height:250px; overflow-y:auto; font-family:monospace; font-size:11px; margin-bottom:12px; color:#0f0;">
                Pronto per scansionare...
            </div>
            <button type="button" onclick="avviaScansionePEC()" style="width:100%; padding:12px; font-size:15px; background:#2196F3;">
                üì• AVVIA SCANSIONE
            </button>
        </div>

        <div style="background:#1a1a1a; padding:20px; border-radius:10px;">
            <h4 style="margin:0 0 15px 0; color:#9C27B0;">üîÑ Riorganizza Fatture</h4>
            <p style="font-size:12px; color:#888; margin:0 0 12px 0;">
                Rinomina automaticamente le fatture gi√† salvate usando i nomi intelligenti estratti dai PDF (data + azienda + numero fattura).
            </p>
            <button type="button" onclick="riorganizzaFattureEsistenti()" style="width:100%; padding:12px; font-size:15px; background:#9C27B0;">
                üîÑ RIORGANIZZA FILE ESISTENTI
            </button>
            
            <button type="button" onclick="mostraGestioneFornitori()" style="width:100%; padding:12px; font-size:15px; background:#FF9800; margin-top:10px;">
                üìÅ CORREGGI NOMI FORNITORI
            </button>
        </div>
    </div>
</section>

<!-- ADMIN - IMPOSTAZIONI STAMPA -->
<section id="sez-admin-stampa" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h3>üñ®Ô∏è IMPOSTAZIONI STAMPA</h3>
    </div>

    <div class="card-centrale" style="max-width: 600px;">
        <h4 style="margin-bottom:20px">Dimensioni Etichetta</h4>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:30px">
            <div>
                <label for="cfg-larghezza" style="color:#000; font-weight:bold; display:block; margin-bottom:8px">Larghezza (mm)</label>
                <input type="number" id="cfg-larghezza" value="40" min="20" max="100" 
                       style="width:100%; padding:10px; font-size:16px; text-align:center">
            </div>
            <div>
                <label for="cfg-altezza" style="color:#000; font-weight:bold; display:block; margin-bottom:8px">Altezza (mm)</label>
                <input type="number" id="cfg-altezza" value="30" min="20" max="100"
                       style="width:100%; padding:10px; font-size:16px; text-align:center">
            </div>
        </div>

        <h4 style="margin-bottom:20px">Layout Etichetta</h4>
        
        <div style="background:#f5f5f5; padding:15px; border-radius:8px; margin-bottom:20px">
            <div style="margin-bottom:15px">
                <label style="color:#000; font-size:16px"><input type="checkbox" id="cfg-mostra-titolo" checked> Mostra "ETICHETTA HACCP"</label>
            </div>
            <div style="margin-bottom:15px">
                <label style="color:#000; font-size:16px"><input type="checkbox" id="cfg-mostra-prodotto" checked> Mostra Prodotto</label>
            </div>
            <div style="margin-bottom:15px">
                <label style="color:#000; font-size:16px"><input type="checkbox" id="cfg-mostra-lotto" checked> Mostra Lotto</label>
            </div>
            <div style="margin-bottom:15px">
                <label style="color:#000; font-size:16px"><input type="checkbox" id="cfg-mostra-produzione" checked> Mostra Data Produzione</label>
            </div>
            <div>
                <label style="color:#000; font-size:16px"><input type="checkbox" id="cfg-mostra-scadenza" checked> Mostra Data Scadenza</label>
            </div>
        </div>

        <h4 style="margin-bottom:20px">Dimensioni Testo</h4>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:30px">
            <div>
                <label for="cfg-size-titolo" style="color:#000; font-weight:bold; display:block; margin-bottom:8px">Titolo</label>
                <select id="cfg-size-titolo" style="width:100%; padding:10px">
                    <option value="2">Piccolo</option>
                    <option value="3" selected>Medio</option>
                    <option value="4">Grande</option>
                </select>
            </div>
            <div>
                <label for="cfg-size-campi" style="color:#000; font-weight:bold; display:block; margin-bottom:8px">Campi</label>
                <select id="cfg-size-campi" style="width:100%; padding:10px">
                    <option value="1">Piccolo</option>
                    <option value="2" selected>Medio</option>
                    <option value="3">Grande</option>
                </select>
            </div>
        </div>

        <h4 style="margin-bottom:20px">Stile Carattere</h4>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:30px">
            <div>
                <label for="cfg-font-titolo" style="color:#000; font-weight:bold; display:block; margin-bottom:8px">Font Titolo</label>
                <select id="cfg-font-titolo" style="width:100%; padding:10px">
                    <option value="3">Standard</option>
                    <option value="4">Grassetto</option>
                    <option value="5">Corsivo</option>
                    <option value="1">Piccolo</option>
                    <option value="TSS24.BF2">Grande Elegante</option>
                </select>
            </div>
            <div>
                <label for="cfg-font-campi" style="color:#000; font-weight:bold; display:block; margin-bottom:8px">Font Campi</label>
                <select id="cfg-font-campi" style="width:100%; padding:10px">
                    <option value="3">Standard</option>
                    <option value="4">Grassetto</option>
                    <option value="5">Corsivo</option>
                    <option value="1">Piccolo</option>
                    <option value="2" selected>Normale</option>
                </select>
            </div>
        </div>

        <button type="button" onclick="salvaConfigurazioneStampa()" style="width:100%; padding:15px; font-size:18px; background:#4CAF50">
            üíæ SALVA CONFIGURAZIONE
        </button>

        <button type="button" onclick="testStampa()" style="width:100%; padding:15px; font-size:16px; background:#2196F3; margin-top:15px">
            üß™ STAMPA DI TEST
        </button>

    </div>
</section>

<!-- OPERATORE - VISUALIZZA FATTURE PEC -->
<section id="sez-op-pec" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA INDIETRO</button>
        <h2>üìÅ FATTURE IMPORTATE</h2>
    </div>

    <div class="contenuto" style="max-width: 900px; margin: 0 auto;">
        <div style="background:#1a1a1a; padding:15px; border-radius:8px; margin-bottom:15px;">
            <p style="color:#888; font-size:0.9rem; margin:0;">Le fatture sono organizzate per fornitore nelle cartelle configurate</p>
        </div>

        <div id="lista-fatture-importate" style="max-height:calc(100vh - 250px); overflow-y:auto;">
            <!-- Lista generata dinamicamente -->
        </div>
        
        <button type="button" onclick="caricaListaFatture()" style="width:100%; padding:10px; font-size:14px; background:#2196F3; margin-top:15px;">
            üîÑ AGGIORNA LISTA
        </button>
    </div>
</section>

<!-- ADMIN - DASHBOARD -->
<section id="sez-admin" class="schermata" style="display:none">
    <header class="header-admin">
        <h2>PANNELLO DI CONTROLLO</h2>
        <p>Benvenuto, Responsabile</p>
        <button onclick="toggleTema()" class="btn-tema" title="Cambia tema">
            <span id="icona-tema">üåô</span>
        </button>
    </header>

    <div class="grid-icone">
        <div class="icona-quadrata" onclick="vaiA('sez-admin-utenti')">
            <span class="emoji">üë§</span>
            <span class="label">UTENTI</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-admin-frigo')">
            <span class="emoji">‚ùÑÔ∏è</span>
            <span class="label">FRIGORIFERI</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-admin-pulizie')" style="border-color: #4CAF50;">
            <span class="emoji">üßº</span>
            <span class="label" style="color: #4CAF50;">PIANO<br>PULIZIE</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-admin-prodotti')" style="border-color: #30D158;">
            <span class="emoji">üì¶</span>
            <span class="label" style="color: #30D158;">PRODOTTI</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-admin-pec')" style="border-color: #00D9FF;">
            <span class="emoji">üìß</span>
            <span class="label" style="color: #00D9FF;">FATTURE<br>PEC</span>
        </div>

        <div class="icona-quadrata" onclick="caricaDashboardAvanzata()" style="border-color: #0A84FF;">
            <span class="emoji">üìä</span>
            <span class="label" style="color: #0A84FF;">GRAFICI<br>ANALISI</span>
        </div>

        <div class="icona-quadrata" onclick="vaiAStorico()">
            <span class="emoji">üìã</span>
            <span class="label">STORICO</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-admin-stampa')" style="border-color: #9C27B0;">
            <span class="emoji">üñ®Ô∏è</span>
            <span class="label">STAMPA</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-admin-firma')" style="border-color: #FF9F0A;">
            <span class="emoji">‚úçÔ∏è</span>
            <span class="label" style="color: #FF9F0A;">FIRMA</span>
        </div>

        <div class="icona-quadrata" onclick="apriGeneratoreReport()" style="border-color: #2196F3;">
            <span class="emoji">üìÑ</span>
            <span class="label" style="color: #2196F3;">REPORT<br>MENSILE</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-admin-backup')" style="border-color: #FF9800;">
            <span class="emoji">üíæ</span>
            <span class="label" style="color: #FF9800;">BACKUP</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-admin-calendario')" style="border-color: #FFD60A;">
            <span class="emoji">üìÖ</span>
            <span class="label" style="color: #FFD60A;">CALENDARIO<br>SCADENZE</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-admin-alert')" style="border-color: #30D158;">
            <span class="emoji">üìß</span>
            <span class="label" style="color: #30D158;">ALERT<br>EMAIL/SMS</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-admin-audit')" style="border-color: #64D2FF;">
            <span class="emoji">üßæ</span>
            <span class="label" style="color: #64D2FF;">AUDIT<br>LOG</span>
        </div>
    </div>

    <button onclick="logout()" class="btn-uscita">CHIUDI SESSIONE</button>
</section>

<!-- ADMIN - PRODOTTI -->
<section id="sez-admin-prodotti" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h3>üì¶ PRODOTTI</h3>
    </div>

    <div class="card-centrale" style="max-width: 600px;">
        <label class="label-oro" for="admin-prodotto-nome" style="margin-bottom:3px; font-size:0.85rem;">NOME PRODOTTO:</label>
        <input type="text" id="admin-prodotto-nome" placeholder="Es: Hamburger" style="margin-bottom:6px;">

        <label class="label-oro" for="admin-prodotto-giorni" style="margin-bottom:3px; font-size:0.85rem;">GIORNI SCADENZA:</label>
        <input type="number" id="admin-prodotto-giorni" placeholder="Es: 3" min="0" style="margin-bottom:10px;">

        <button type="button" onclick="aggiungiProdottoAdmin()" style="width:100%; padding:12px; background:#30D158;">‚úÖ AGGIUNGI</button>
    </div>

    <div id="lista-prodotti-admin" class="elenco-dati"></div>
</section>

<!-- ADMIN - PIANO PULIZIE -->
<section id="sez-admin-pulizie" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h3>üßº PIANO PULIZIE</h3>
    </div>

    <div class="card-centrale" style="max-width: 680px;">
        <h4 style="margin-bottom:14px;">Nuova pulizia programmata</h4>

        <input type="hidden" id="pulizia-edit-id">

        <label class="label-oro" for="pulizia-nome" style="margin-bottom:3px; font-size:0.85rem;">NOME ATTIVITA:</label>
        <input type="text" id="pulizia-nome" placeholder="Es: Bancone vendita" style="margin-bottom:8px;">

        <label class="label-oro" for="pulizia-frequenza" style="margin-bottom:3px; font-size:0.85rem;">FREQUENZA:</label>
        <select id="pulizia-frequenza" onchange="aggiornaPianoPuliziaCampi()" style="margin-bottom:8px;">
            <option value="daily">Ogni giorno</option>
            <option value="weekly">Ogni settimana</option>
            <option value="monthly">Ogni mese</option>
            <option value="interval">Ogni X giorni</option>
        </select>

        <div id="pulizia-campo-settimanale" class="piano-row" style="display:none;">
            <label class="label-oro" for="pulizia-giorno-sett" style="margin-bottom:3px; font-size:0.85rem;">GIORNO SETTIMANA:</label>
            <select id="pulizia-giorno-sett">
                <option value="1">Lunedi</option>
                <option value="2">Martedi</option>
                <option value="3">Mercoledi</option>
                <option value="4">Giovedi</option>
                <option value="5">Venerdi</option>
                <option value="6">Sabato</option>
                <option value="0">Domenica</option>
            </select>
        </div>

        <div id="pulizia-campo-mensile" class="piano-row" style="display:none;">
            <label class="label-oro" for="pulizia-giorno-mese" style="margin-bottom:3px; font-size:0.85rem;">GIORNO DEL MESE:</label>
            <input type="number" id="pulizia-giorno-mese" min="1" max="31" value="1">
        </div>

        <div id="pulizia-campo-intervallo" class="piano-row" style="display:none;">
            <label class="label-oro" for="pulizia-intervallo" style="margin-bottom:3px; font-size:0.85rem;">OGNI (GIORNI):</label>
            <input type="number" id="pulizia-intervallo" min="1" value="7">
        </div>

        <div id="pulizia-campo-start" class="piano-row">
            <label class="label-oro" for="pulizia-start" style="margin-bottom:3px; font-size:0.85rem;">DATA INIZIO:</label>
            <input type="date" id="pulizia-start">
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button type="button" onclick="salvaPianoPulizia()" style="flex:1; background:#30D158;">üíæ SALVA</button>
            <button type="button" onclick="resetPianoPuliziaForm()" style="flex:1; background:#444;">ANNULLA</button>
        </div>
    </div>

    <div id="piano-pulizie-ritardi" class="elenco-dati" style="max-width: 680px; margin: 0 auto 18px;"></div>
    <div id="lista-piano-pulizie" class="elenco-dati" style="max-width: 680px; margin: 0 auto 30px;"></div>
</section>

<!-- OPERATORE - SCADENZARIO -->
<section id="sez-op-scadenzario" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA INDIETRO</button>
        <h2>üìÖ SCADENZARIO PRODOTTI</h2>
    </div>
    <div class="contenuto">
        <div id="alert-scadenze" style="margin-bottom:20px;"></div>
        <div id="lista-scadenze"></div>
    </div>
</section>

<!-- OPERATORE - MANUTENZIONI -->
<section id="sez-op-manutenzioni" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA INDIETRO</button>
        <h2>üîß MANUTENZIONI ATTREZZATURE</h2>
    </div>
    <div class="contenuto">
        <button type="button" onclick="aggiungiAttrezzatura()" style="width:100%; padding:15px; background:#4CAF50; margin-bottom:20px;">‚ûï NUOVA ATTREZZATURA</button>
        <div id="lista-attrezzature"></div>
    </div>
</section>

<!-- OPERATORE - FORNITORI -->
<section id="sez-op-fornitori" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA INDIETRO</button>
        <h2>üè¢ REGISTRO FORNITORI QUALIFICATI</h2>
    </div>
    <div class="contenuto">
        <button type="button" onclick="aggiungiFornitore()" style="width:100%; padding:15px; background:#4CAF50; margin-bottom:20px;">‚ûï NUOVO FORNITORE</button>
        <div id="lista-fornitori"></div>
    </div>
</section>

<!-- OPERATORE - ALLERGENI -->
<section id="sez-op-allergeni" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA INDIETRO</button>
        <h2>‚ö†Ô∏è REGISTRO ALLERGENI</h2>
    </div>
    <div class="contenuto">
        <button type="button" onclick="aggiungiProdottoAllergeni()" style="width:100%; padding:15px; background:#4CAF50; margin-bottom:20px;">‚ûï NUOVO PRODOTTO</button>
        <div id="lista-allergeni"></div>
    </div>
</section>

<!-- OPERATORE - CCP -->
<section id="sez-op-ccp" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA INDIETRO</button>
        <h2>üìã PUNTI CRITICI DI CONTROLLO (CCP)</h2>
    </div>
    <div class="contenuto">
        <button type="button" onclick="registraControlloCCP()" style="width:100%; padding:15px; background:#4CAF50; margin-bottom:20px;">‚úÖ REGISTRA CONTROLLO</button>
        <div id="lista-ccp"></div>
    </div>
</section>

<!-- OPERATORE - FORMAZIONE -->
<section id="sez-op-formazione" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA INDIETRO</button>
        <h2>üéì FORMAZIONE PERSONALE</h2>
    </div>
    <div class="contenuto">
        <button type="button" onclick="aggiungiAttestato()" style="width:100%; padding:15px; background:#4CAF50; margin-bottom:20px;">‚ûï NUOVO ATTESTATO</button>
        <div id="alert-scadenze-formazione" style="margin-bottom:20px;"></div>
        <div id="lista-formazione"></div>
    </div>
</section>

<!-- OPERATORE - INVENTARIO -->
<section id="sez-op-inventario" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA INDIETRO</button>
        <h2>üì¶ INVENTARIO MATERIE PRIME</h2>
    </div>
    <div class="contenuto">
        <button type="button" onclick="aggiungiMateriaPrima()" style="width:100%; padding:15px; background:#4CAF50; margin-bottom:20px;">‚ûï AGGIUNGI GIACENZA</button>
        <div id="lista-inventario"></div>
    </div>
</section>

<!-- ADMIN - DASHBOARD -->
<section id="sez-admin-dashboard" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h2>üìä DASHBOARD AVANZATA</h2>
    </div>
    
    <div class="contenuto" style="max-width: 1400px; margin: 0 auto; padding: 24px;">
        
        <!-- Card Statistiche -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
            <div class="stat-card">
                <div class="stat-icon">üå°Ô∏è</div>
                <div class="stat-value" id="stat-temperature">0</div>
                <div class="stat-label">Controlli Temp.</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üè∑Ô∏è</div>
                <div class="stat-value" id="stat-lotti">0</div>
                <div class="stat-label">Lotti Attivi</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-value" id="stat-nc">0</div>
                <div class="stat-label">Non Conformit√†</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-value" id="stat-scadenze">0</div>
                <div class="stat-label">In Scadenza</div>
            </div>
        </div>

        <!-- Grafici -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="chart-container">
                <h3>Temperature Ultimi 7 Giorni</h3>
                <canvas id="chartTemperature"></canvas>
            </div>
            <div class="chart-container">
                <h3>Lotti per Categoria</h3>
                <canvas id="chartLotti"></canvas>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="chart-container">
                <h3>Non Conformit√† per Tipo</h3>
                <canvas id="chartNC"></canvas>
            </div>
            <div class="chart-container">
                <h3>Scadenze Prossime 30 Giorni</h3>
                <canvas id="chartScadenze"></canvas>
            </div>
        </div>

    </div>
</section>

<!-- ADMIN - EXPORT PDF REPORT -->
<section id="sez-admin-report" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h2>üìÑ GENERA REPORT HACCP</h2>
    </div>
    
    <div class="contenuto report-screen">
        
        <div class="card-centrale report-card">
            <h3 class="report-title">Seleziona Periodo Report</h3>

            <div class="report-customization">
                <label class="label-oro" for="report-preset-select">Preset PDF</label>
                <select id="report-preset-select">
                    <option value="standard" selected>Standard</option>
                    <option value="minimal">Minimal</option>
                    <option value="official">Ufficiale</option>
                </select>

                <label class="label-oro" for="report-title-input">Titolo Report</label>
                <input type="text" id="report-title-input" placeholder="REPORT HACCP">

                <label class="label-oro" for="report-color-input">Colore Principale</label>
                <input type="color" id="report-color-input" value="#0A84FF">

                <label class="label-oro" for="report-logo-input">Logo (immagine)</label>
                <input type="file" id="report-logo-input" accept="image/*">
                <div id="report-logo-preview" style="display:none; margin: 8px 0; text-align:center;"></div>
                <button type="button" onclick="rimuoviLogoReport()" style="width:100%; padding:10px; background:#444; margin-bottom:10px;">
                    Rimuovi logo
                </button>

                <label style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                    <input type="checkbox" id="report-include-signature" checked>
                    Includi firma operatore
                </label>
            </div>
            
            <div class="report-date-grid">
                <div class="report-field">
                    <label class="label-oro" for="report-data-inizio">Data Inizio</label>
                    <input type="date" id="report-data-inizio" class="report-date-input">
                </div>
                <div class="report-field">
                    <label class="label-oro" for="report-data-fine">Data Fine</label>
                    <input type="date" id="report-data-fine" class="report-date-input">
                </div>
            </div>
            
            <h3 class="report-subtitle">Sezioni da Includere</h3>
            
            <div class="report-section-list">
                <label class="report-section-item">
                    <input type="checkbox" id="report-inc-temp" checked> üå°Ô∏è Temperature Frigoriferi
                </label>
                <label class="report-section-item">
                    <input type="checkbox" id="report-inc-lotti" checked> üè∑Ô∏è Lotti Produzione
                </label>
                <label class="report-section-item">
                    <input type="checkbox" id="report-inc-nc" checked> ‚ö†Ô∏è Non Conformit√†
                </label>
                <label class="report-section-item">
                    <input type="checkbox" id="report-inc-sanif" checked> üßº Sanificazioni
                </label>
                <label class="report-section-item">
                    <input type="checkbox" id="report-inc-manut" checked> üîß Manutenzioni
                </label>
                <label class="report-section-item">
                    <input type="checkbox" id="report-inc-form" checked> üéì Formazione Personale
                </label>
            </div>
            
            <button onclick="generaReportPDF()" class="report-action-btn">
                üì• GENERA E SCARICA PDF
            </button>
        </div>
        
    </div>
</section>

<!-- ADMIN - BACKUP & RESTORE -->
<section id="sez-admin-backup" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h2>üíæ BACKUP E RIPRISTINO</h2>
    </div>
    
    <div class="contenuto" style="max-width: 900px; margin: 0 auto;">

        <!-- Importa da Cloud Render -->
        <div class="card-centrale" style="padding: 32px; margin-bottom: 24px;">
            <h3 style="margin-bottom: 16px;">‚òÅÔ∏è Importa da Cloud Render</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Scarica i dati dal MongoDB su Render e li copia in questo computer.
            </p>
            <label for="render-url-input" style="display: block; margin-bottom: 8px; color: var(--oro);">URL Render:</label>
            <input type="text" id="render-url-input" placeholder="https://vittorio-az8f.onrender.com" style="margin-bottom: 16px; width: 100%;">
            <button onclick="importaDatiDaRender()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #0A84FF, #0066CC);">
                ‚¨áÔ∏è IMPORTA DATI DAL CLOUD
            </button>
        </div>
        
        <!-- Export Dati -->
        <div class="card-centrale" style="padding: 32px; margin-bottom: 24px;">
            <h3 style="margin-bottom: 16px;">üì§ Esporta Dati</h3>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                Scarica un file JSON con tutti i dati dell'applicazione. Conservalo in un luogo sicuro.
            </p>
            <button onclick="esportaDatiCompleti()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #30D158, #28a745);">
                üíæ ESPORTA TUTTI I DATI (JSON)
            </button>
        </div>
        
        <!-- Import Dati -->
        <div class="card-centrale" style="padding: 32px; margin-bottom: 24px;">
            <h3 style="margin-bottom: 16px;">üì• Importa/Ripristina Dati</h3>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                ‚ö†Ô∏è ATTENZIONE: Questa operazione sovrascriver√† tutti i dati esistenti!
            </p>
            <label for="file-import-backup" style="display: block; margin-bottom: 8px; color: var(--oro);">Seleziona file backup:</label>
            <input type="file" id="file-import-backup" accept=".json" style="margin-bottom: 16px;">
            <button onclick="importaDatiCompleti()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #FF9F0A, #f57c00);">
                üì• CARICA E RIPRISTINA BACKUP
            </button>
        </div>
        
        <!-- Backup Automatico -->
        <div class="card-centrale" style="padding: 32px;">
            <h3 style="margin-bottom: 16px;">‚è∞ Backup Automatico</h3>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                Programma backup automatici periodici dei dati.
            </p>
            
            <label class="label-oro" for="backup-frequenza">Frequenza Backup</label>
            <select id="backup-frequenza" style="margin-bottom: 16px;">
                <option value="disabled">Disabilitato</option>
                <option value="daily">Giornaliero (ore 23:00)</option>
                <option value="weekly">Settimanale (Domenica 23:00)</option>
                <option value="monthly">Mensile (Ultimo giorno del mese)</option>
            </select>
            
            <button onclick="salvaImpostazioniBackup()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #0A84FF, #2196F3);">
                ‚úÖ SALVA IMPOSTAZIONI
            </button>
            
            <div id="info-ultimo-backup" style="margin-top: 20px; padding: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; text-align: center;">
                <small>Ultimo backup: Mai effettuato</small>
            </div>
        </div>
        
    </div>
</section>

<!-- ADMIN - CALENDARIO SCADENZE -->
<section id="sez-admin-calendario" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h2>üìÖ CALENDARIO SCADENZE</h2>
    </div>
    
    <div class="contenuto calendario-wrapper">
        
        <!-- Controlli Navigazione -->
        <div class="calendario-toolbar">
            <button onclick="calendarioMesePrecedente()">‚¨Ö Mese Prec.</button>
            <h3 id="calendario-mese-anno">Gennaio 2026</h3>
            <button onclick="calendarioMeseSuccessivo()">Mese Succ. ‚û°</button>
        </div>
        
        <!-- Legenda -->
        <div class="calendario-legend">
            <div class="calendario-legend-item">
                <div class="calendario-legend-dot" style="background: #FF453A;"></div>
                <span>Scaduto</span>
            </div>
            <div class="calendario-legend-item">
                <div class="calendario-legend-dot" style="background: #FF9F0A;"></div>
                <span>Critico (0-3 gg)</span>
            </div>
            <div class="calendario-legend-item">
                <div class="calendario-legend-dot" style="background: #FFD60A;"></div>
                <span>Imminente (4-7 gg)</span>
            </div>
            <div class="calendario-legend-item">
                <div class="calendario-legend-dot" style="background: #30D158;"></div>
                <span>OK (>7 gg)</span>
            </div>
        </div>
        
        <!-- Griglia Calendario -->
        <div id="calendario-container" class="calendario-container">
            <!-- Intestazione giorni settimana -->
            <div class="calendario-weekdays">
                <div class="calendario-weekday">Lun</div>
                <div class="calendario-weekday">Mar</div>
                <div class="calendario-weekday">Mer</div>
                <div class="calendario-weekday">Gio</div>
                <div class="calendario-weekday">Ven</div>
                <div class="calendario-weekday">Sab</div>
                <div class="calendario-weekday">Dom</div>
            </div>
            
            <!-- Giorni del mese (generati dinamicamente) -->
            <div id="calendario-giorni" class="calendario-giorni-grid">
                <!-- Popolato da JavaScript -->
            </div>
        </div>
        
        <!-- Dettagli Giorno Selezionato -->
        <div id="calendario-dettagli" class="calendario-dettagli">
            <h3 id="calendario-dettagli-titolo">Prodotti in scadenza</h3>
            <div id="calendario-dettagli-lista"></div>
        </div>
        
    </div>
</section>

<!-- ADMIN - CONFIGURAZIONE ALERT EMAIL/WHATSAPP -->
<section id="sez-admin-alert" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA INDIETRO</button>
        <h2>üìß CONFIGURAZIONE ALERT</h2>
    </div>
    
    <div class="contenuto" style="max-width: 900px; margin: 0 auto;">

        <div class="card-centrale" style="padding: 24px; margin-bottom: 24px;">
            <h3 style="margin-bottom: 12px;">üîî Notifiche Intelligenti</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Mostra solo avvisi critici e prioritari.
            </p>
            <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="notif-smart-toggle" checked>
                Attiva filtro intelligente
            </label>
        </div>
        
        <!-- Alert Email -->
        <div class="card-centrale" style="padding: 32px; margin-bottom: 24px;">
            <h3 style="margin-bottom: 24px;">üìß Alert Email</h3>
            
            <label class="label-oro" for="alert-email-enabled">Abilita Notifiche Email</label>
            <select id="alert-email-enabled" style="margin-bottom: 16px;">
                <option value="false">Disabilitate</option>
                <option value="true">Abilitate</option>
            </select>
            
            <label class="label-oro" for="alert-email-destinatario">Email Destinatario</label>
            <input type="email" id="alert-email-destinatario" placeholder="esempio@email.it" style="margin-bottom: 16px;">
            
            <label class="label-oro" for="alert-email-smtp">Server SMTP</label>
            <input type="text" id="alert-email-smtp" placeholder="smtp.gmail.com" value="smtp.gmail.com" style="margin-bottom: 16px;">
            
            <label class="label-oro" for="alert-email-porta">Porta SMTP</label>
            <input type="number" id="alert-email-porta" placeholder="587" value="587" style="margin-bottom: 16px;">
            
            <label class="label-oro" for="alert-email-mittente">Email Mittente</label>
            <input type="email" id="alert-email-mittente" placeholder="haccp@tuodominio.it" style="margin-bottom: 16px;">
            
            <label class="label-oro" for="alert-email-password">Password Email</label>
            <input type="password" id="alert-email-password" placeholder="Password app" style="margin-bottom: 24px;">
            
            <h4 style="margin-bottom: 16px;">Eventi da Monitorare</h4>
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 12px;">
                    <input type="checkbox" id="alert-email-scadenze" checked> Prodotti in scadenza critica
                </label>
                <label style="display: block; margin-bottom: 12px;">
                    <input type="checkbox" id="alert-email-temperature" checked> Temperature fuori range
                </label>
                <label style="display: block; margin-bottom: 12px;">
                    <input type="checkbox" id="alert-email-nc" checked> Nuove non conformit√†
                </label>
                <label style="display: block;">
                    <input type="checkbox" id="alert-email-manutenzioni" checked> Manutenzioni in scadenza
                </label>
            </div>
            
            <button onclick="testEmail()" style="width: 100%; padding: 12px; margin-bottom: 12px; background: linear-gradient(135deg, #64D2FF, #2196F3);">
                üß™ INVIA EMAIL DI TEST
            </button>
            
            <button onclick="salvaConfigurazioneEmail()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #30D158, #28a745);">
                ‚úÖ SALVA CONFIGURAZIONE EMAIL
            </button>
        </div>
        
        <!-- Alert WhatsApp -->
        <div class="card-centrale" style="padding: 32px;">
            <h3 style="margin-bottom: 24px;">üí¨ Alert WhatsApp</h3>
            
            <label class="label-oro" for="alert-whatsapp-enabled">Abilita Notifiche WhatsApp</label>
            <select id="alert-whatsapp-enabled" style="margin-bottom: 16px;">
                <option value="false">Disabilitate</option>
                <option value="true">Abilitate</option>
            </select>
            
            <label class="label-oro" for="alert-whatsapp-numero">Numero WhatsApp (con prefisso +39)</label>
            <input type="tel" id="alert-whatsapp-numero" placeholder="+393331234567" style="margin-bottom: 16px;">
            
            <label class="label-oro" for="alert-whatsapp-apikey">API Key Twilio/CallMeBot</label>
            <input type="text" id="alert-whatsapp-apikey" placeholder="Inserisci API Key" style="margin-bottom: 16px;">
            
            <label class="label-oro" for="alert-whatsapp-sid">Account SID (Twilio)</label>
            <input type="text" id="alert-whatsapp-sid" placeholder="ACxxxxxxxxxxxxxx" style="margin-bottom: 24px;">
            
            <h4 style="margin-bottom: 16px;">Eventi da Monitorare</h4>
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 12px;">
                    <input type="checkbox" id="alert-whatsapp-scadenze" checked> Prodotti scaduti
                </label>
                <label style="display: block; margin-bottom: 12px;">
                    <input type="checkbox" id="alert-whatsapp-temperature" checked> Temperature critiche
                </label>
                <label style="display: block;">
                    <input type="checkbox" id="alert-whatsapp-nc" checked> Non conformit√† gravi
                </label>
            </div>
            
            <button onclick="testWhatsApp()" style="width: 100%; padding: 12px; margin-bottom: 12px; background: linear-gradient(135deg, #30D158, #25D366);">
                üß™ INVIA MESSAGGIO DI TEST
            </button>
            
            <button onclick="salvaConfigurazioneWhatsApp()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #30D158, #28a745);">
                ‚úÖ SALVA CONFIGURAZIONE WHATSAPP
            </button>
        </div>
        
    </div>
</section>

<!-- OPERATORE - DASHBOARD -->
<section id="sez-operatore" class="schermata" style="display:none">
    <header class="header-app">
        <div class="user-info">
            <span class="emoji">üë§</span>
            <div>
                <strong id="nome-operatore">---</strong>
                <small id="ruolo-operatore" style="display:block; font-size: 0.7rem; opacity: 0.8;"></small>
            </div>
        </div>
        <button onclick="toggleTema()" class="btn-tema-mini" title="Cambia tema">
            <span id="icona-tema-op">üåô</span>
        </button>
        <button onclick="logout()" class="btn-logout">ESCI</button>
    </header>

    <div id="stato-attivita" class="stato-vuoto">
        <span id="testo-stato">Caricamento...</span>
    </div>

    <div id="pulizie-home-badge" class="pulizie-home-badge" style="display:none;"></div>

    <div style="padding: 0 20px 20px; max-width: 900px; margin: 0 auto;">
        <div style="background:#1a1a1a; border-radius:16px; padding:16px; border:1px solid #2a2a2a;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
                <h3 style="margin:0;">üìå PRENOTAZIONI DI OGGI</h3>
                <div style="font-size:11px; color:#aaa;">Dashboard</div>
            </div>
            <div id="lista-ordini-home" class="ordini-home-list"></div>
        </div>
    </div>

    <!-- Dashboard Stats -->
    <div id="dashboard-stats" style="padding: 20px; max-width: 1200px; margin: 0 auto 30px;"></div>
    <div id="dashboard-grafici" style="padding: 20px; max-width: 1200px; margin: 0 auto;"></div>

    <div class="grid-icone">
        <div class="icona-quadrata" onclick="vaiA('sez-op-temperature')">
            <span class="emoji">‚ùÑÔ∏è</span>
            <span class="label">FRIGORIFERI</span>
        </div>
        
        <div class="icona-quadrata" onclick="vaiAPulizie()">
            <span class="emoji">üßº</span>
            <span class="label">PULIZIE</span>
        </div>

        <div class="icona-quadrata" onclick="vaiANC()" style="border-color: #FF453A;">
            <span class="emoji">‚ö†Ô∏è</span>
            <span class="label" style="color: #FF453A;">NON<br>CONFORMITA</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-op-lotti')">
            <span class="emoji">üì¶</span>
            <span class="label">TRACCIA-<br>BILITA</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-op-ordini')" style="border-color: #30D158;">
            <span class="emoji">üìù</span>
            <span class="label" style="color: #30D158;">ORDINI</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-op-etichetta')" style="border-color: #9C27B0;">
            <span class="emoji">üñ®Ô∏è</span>
            <span class="label" style="color: #9C27B0;">ETICHETTA<br>PRODOTTO</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-op-pec')" style="border-color: #FF9800;">
            <span class="emoji">üìß</span>
            <span class="label" style="color: #FF9800;">PEC</span>
        </div>
    </div>

    <div style="display:flex; justify-content:center; gap:12px; padding: 18px 20px 8px; flex-wrap:wrap;">
        <button type="button" onclick="vaiA('sez-op-archivi')" style="padding:10px 16px; border-radius:999px; background:#1f2a36; border:1px solid #2c3a49; color:#fff; font-size:12px;">
            üìÅ I MIEI ARCHIVI
        </button>
        <button type="button" onclick="apriGeneratoreReport()" style="padding:10px 16px; border-radius:999px; background:#1f2a36; border:1px solid #2c3a49; color:#fff; font-size:12px;">
            üìÑ I MIEI DOCUMENTI
        </button>
    </div>
</section>

<!-- OPERATORE - PRESA ORDINI -->
<section id="sez-op-ordini" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA AL MENU</button>
        <h2>üìù PRESA ORDINE</h2>
    </div>

    <div class="ordini-screen">
        <div class="ordini-view ordini-view-lista active" id="ordini-view-lista">
            <div id="ordini-empty" class="ordini-empty">Nessun promemoria</div>
            <div id="lista-ordini-dashboard" class="ordini-lista" style="display:none;"></div>
        </div>

        <div class="ordini-view ordini-view-nota" id="ordini-view-nota">
            <div class="ordini-note-header">
                <button type="button" class="ordini-note-back" onclick="tornaListaOrdini()">‚óÄÔ∏é</button>
                <div class="ordini-note-titlebar">Promemoria</div>
                <button type="button" class="ordini-note-save" onclick="salvaOrdine()">‚úì</button>
            </div>
            <div class="ordini-note-shell">
                <div class="ordini-note-topbar">Aggiungi nota</div>
                <input type="text" id="ordine-titolo" class="ordini-note-field ordini-note-title" placeholder="Titolo">
                <textarea id="ordine-contesto" class="ordini-note-field ordini-note-context" placeholder="Contesto"></textarea>
                <div id="ordine-data-label" class="ordini-note-date"></div>
                <div class="ordini-date-chip">
                    <button type="button" class="ordini-calendar-btn" onclick="toggleCalendarioOrdini(true)">
                        <img alt="Calendario" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23cbd2e6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='3' y='4' width='18' height='18' rx='2' ry='2'/><line x1='16' y1='2' x2='16' y2='6'/><line x1='8' y1='2' x2='8' y2='6'/><line x1='3' y1='10' x2='21' y2='10'/></svg>">
                    </button>
                </div>
                <div class="ordini-note-toolbar">‚òê  ‚úé  Aa  ‚åò  #  ‚éô</div>
            </div>
        </div>
    </div>

    <button type="button" class="ordini-fab" onclick="apriNuovoOrdine()">+</button>
</section>

<div class="ordini-modal" id="ordini-modal">
    <div class="ordini-modal-card">
        <div class="ordini-modal-header">
            <button type="button" class="ordini-modal-close" onclick="toggleCalendarioOrdini(false)">√ó</button>
            <div class="ordini-modal-title">Data e ora</div>
            <div class="ordini-modal-actions">
                <button type="button" class="ordini-modal-delete" id="ordini-modal-delete" onclick="eliminaOrdineDaModal()">üóë</button>
                <button type="button" class="ordini-modal-check" onclick="toggleCalendarioOrdini(false)">‚úì</button>
            </div>
        </div>
        <div class="ordini-modal-row ordini-modal-row-month">
            <button type="button" class="ordini-month-btn" onclick="cambiaMeseOrdini(-1)">‚óÄÔ∏é</button>
            <div class="ordini-calendar-title" id="ordini-calendar-title"></div>
            <button type="button" class="ordini-month-btn" onclick="cambiaMeseOrdini(1)">‚ñ∂Ô∏é</button>
        </div>
        <div class="ordini-calendar-grid" id="ordini-calendar-grid"></div>
        <div class="ordini-modal-row ordini-time-row">
            <label class="ordini-time-label">
                <input type="checkbox" id="ordine-ora-toggle" onchange="toggleOraOrdine()"> Ora
            </label>
            <input type="time" id="ordine-ora" class="ordini-time-input" onchange="selezionaOraOrdine()" disabled>
        </div>
    </div>
</div>

<button id="btn-back-fixed" type="button" onclick="vaiA('sez-operatore')" style="display:none;" aria-label="Torna al menu">
    ‚¨Ö
</button>

<!-- OPERATORE - ARCHIVI -->
<section id="sez-op-archivi" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA AL MENU</button>
        <h2>üìÅ I MIEI ARCHIVI</h2>
    </div>

    <div class="grid-icone" style="padding: 20px; max-width: 1200px; margin: 0 auto;">
        <div class="icona-quadrata" onclick="vaiA('sez-op-temp-archivio')">
            <span class="emoji">‚ùÑÔ∏è</span>
            <span class="label">FRIGORIFERI</span>
        </div>
        
        <div class="icona-quadrata" onclick="vaiAPulizie()">
            <span class="emoji">üßº</span>
            <span class="label">PULIZIE</span>
        </div>

        <div class="icona-quadrata" onclick="vaiANC()" style="border-color: #FF453A;">
            <span class="emoji">‚ö†Ô∏è</span>
            <span class="label" style="color: #FF453A;">NON<br>CONFORMITA</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-op-lotti-archivio')">
            <span class="emoji">üì¶</span>
            <span class="label">TRACCIA-<br>BILITA</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-op-etichetta')" style="border-color: #9C27B0;">
            <span class="emoji">üñ®Ô∏è</span>
            <span class="label" style="color: #9C27B0;">ETICHETTA<br>PRODOTTO</span>
        </div>

        <div class="icona-quadrata" onclick="vaiA('sez-op-pec')" style="border-color: #FF9800;">
            <span class="emoji">üìß</span>
            <span class="label" style="color: #FF9800;">PEC</span>
        </div>
    </div>
</section>

<!-- OPERATORE - ETICHETTA PERSONALIZZATA -->
<section id="sez-op-etichetta" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA AL MENU</button>
        <h2>üñ®Ô∏è ETICHETTA PERSONALIZZATA</h2>
    </div>

    <div style="max-width: 1000px; margin: 0 auto; padding: 20px; display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
        <div class="card-centrale" style="max-width:none;">
            <h3 style="margin-bottom:10px;">ETICHETTA PERSONALIZZATA</h3>
            <div style="display:grid; gap:8px; max-width:320px; margin:0 auto 10px;">
                <input type="text" id="custom-etichetta-nome" placeholder="Nome etichetta" style="text-align:center;" oninput="aggiornaAnteprimaEtichettaPersonalizzata()">
                <input type="text" id="custom-etichetta-label" placeholder="Etichetta" style="text-align:center;" oninput="aggiornaAnteprimaEtichettaPersonalizzata()">
                <input type="text" id="custom-etichetta-valore" placeholder="Valore" style="text-align:center;" oninput="aggiornaAnteprimaEtichettaPersonalizzata()">
            </div>

            <button type="button" data-allow-stampa="true" onclick="stampaEtichettaPersonalizzata()" style="width:100%; padding:12px; background:#30D158; font-weight:700;">STAMPA</button>
        </div>

        <div class="card-centrale" style="max-width:none;">
            <h3 style="margin-bottom:10px;">ANTEPRIMA</h3>
            <div style="background:#fff; color:#000; border-radius:8px; padding:12px; max-width:380px; margin:0 auto; box-shadow:0 6px 16px rgba(0,0,0,0.35); font-family: Arial, sans-serif; font-size:12px;">
                <div id="custom-preview-title" style="font-weight:800; font-size:14px; margin-bottom:6px; text-align:center;"></div>
                <div style="display:flex; justify-content:space-between; gap:8px; border-bottom:1px dashed #bbb; padding:4px 0;">
                    <span id="custom-preview-label" style="font-weight:700;"></span>
                    <span id="custom-preview-value"></span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- OPERATORE - REGISTRA TEMPERATURE -->
<section id="sez-op-temperature" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA AL MENU</button>
        <h3>REGISTRA TEMPERATURE</h3>
    </div>

    <div class="card-centrale" style="max-width: 700px;">
        <div id="lista-temperature-frigo"></div>
        <button type="button" onclick="copiaUltimeTemperature()" style="width:100%; padding:12px; background:#2196F3; margin-bottom:10px;">
            üîÅ RIPETI ULTIME TEMPERATURE
        </button>
        <button type="button" onclick="salvaTemperatureGiornaliere()" style="width:100%; padding:12px; background:#30D158;">
            ‚úÖ SALVA
        </button>
    </div>

    <div id="temp-nc-overlay" class="temp-nc-overlay">
        <div id="temp-nc-card" class="card-centrale temp-nc-card">
            <div class="temp-nc-header">
                <h3 class="temp-nc-title">NON CONFORMITA TEMPERATURE</h3>
                <button type="button" class="temp-nc-close" onclick="chiudiTempNC()">‚úï Chiudi</button>
            </div>

            <div id="temp-nc-alert" class="temp-nc-alert"></div>

            <div class="temp-nc-grid">
                <div class="temp-nc-field">
                    <label class="label-oro" for="temp-nc-data">Data</label>
                    <input type="date" id="temp-nc-data" class="temp-nc-input">
                </div>
                <div class="temp-nc-field">
                    <label class="label-oro" for="temp-nc-ora">Ora</label>
                    <input type="time" id="temp-nc-ora" class="temp-nc-input">
                </div>
            </div>

            <div class="temp-nc-field">
                <label class="label-oro" for="temp-nc-frigo">Frigorifero</label>
                <select id="temp-nc-frigo" class="temp-nc-input"></select>
            </div>

            <div class="temp-nc-grid">
                <div class="temp-nc-field">
                    <label class="label-oro" for="temp-nc-frigo-val">Temperatura Frigo</label>
                    <input type="number" step="0.1" id="temp-nc-frigo-val" class="temp-nc-input" placeholder="¬∞C">
                </div>
                <div class="temp-nc-field">
                    <label class="label-oro" for="temp-nc-freezer-val">Temperatura Freezer</label>
                    <input type="number" step="0.1" id="temp-nc-freezer-val" class="temp-nc-input" placeholder="¬∞C">
                </div>
            </div>

            <div class="temp-nc-field">
                <label class="label-oro" for="temp-nc-motivo">Motivo</label>
                <select id="temp-nc-motivo" class="temp-nc-input">
                    <option value="Temperatura Fuori Range">üå°Ô∏è Temperatura Fuori Range</option>
                    <option value="Mancata Rilevazione">‚è±Ô∏è Mancata Rilevazione</option>
                </select>
            </div>

            <div class="temp-nc-field">
                <label class="label-oro" for="temp-nc-azione">Azione correttiva</label>
                <textarea id="temp-nc-azione" class="temp-nc-textarea" placeholder="Descrivi l'azione intrapresa..."></textarea>
            </div>

            <div class="temp-nc-grid">
                <div class="temp-nc-field">
                    <label class="label-oro" for="temp-nc-resp">Responsabile</label>
                    <input type="text" id="temp-nc-resp" class="temp-nc-input" placeholder="Operatore">
                </div>
                <div class="temp-nc-field">
                    <label class="label-oro" for="temp-nc-foto">Foto (opzionale)</label>
                    <input type="file" id="temp-nc-foto" class="temp-nc-input" accept="image/*" capture="environment" onchange="gestisciFotoTempNC(this)">
                    <div id="temp-nc-foto-preview" class="temp-nc-preview"></div>
                </div>
            </div>

            <button type="button" class="temp-nc-save" onclick="salvaNonConformitaTemperatura()">
                ‚úÖ SALVA NON CONFORMITA
            </button>

            <div id="temp-nc-lista" class="temp-nc-lista"></div>
        </div>
    </div>
</section>

<!-- OPERATORE - ARCHIVIO TEMPERATURE -->
<section id="sez-op-temp-archivio" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-op-archivi')">‚¨Ö TORNA AL MENU</button>
        <h3>üìÖ ARCHIVIO TEMPERATURE</h3>
    </div>

    <div class="contenuto" style="max-width: 900px; margin: 0 auto;">
        <div style="background:#1a1a1a; padding:15px; border-radius:8px; margin-bottom:15px;">
            <p style="color:#888; font-size:0.9rem; margin:0;">Seleziona un giorno e controlla tutte le temperature</p>
        </div>

        <div id="lista-giorni-temperature" style="margin-bottom:15px;"></div>
        <div id="lista-temperature-giorno"></div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
            <button type="button" data-allow-stampa="true" onclick="stampaTemperatureArchivioSistema()" style="padding:10px 14px; background:#2196F3;">
                üñ®Ô∏è STAMPA
            </button>
        </div>
    </div>
</section>

<!-- OPERATORE - TRACCIABILITA (CAMERA) -->
<section id="sez-op-lotti" class="schermata" style="display:none">
    <div class="header-data">
        <button onclick="vaiA('sez-operatore')" class="btn-mini-back">‚¨Ö MENU</button>
        <h3 style="color: var(--oro); margin: 0;">TRACCIABILITA</h3>
        <div style="width: 80px;"></div>
    </div>

    <div style="padding: 20px; max-width: 1000px; margin: auto; position:relative;">
        <div style="background:#1a1a1a; padding:12px; border-radius:10px; border:1px dashed #333;">
            <div style="color:#aaa; font-size:12px; margin-bottom:6px;">FOTOCAMERA</div>
            <div style="background:#000; border-radius:10px; overflow:hidden; position:relative; aspect-ratio:1 / 1; width:100%; max-width:480px; max-height:480px; margin:0 auto;">
                <video id="camera-ingredienti" playsinline autoplay muted style="width:100%; height:100%; object-fit:cover; display:block;"></video>
                <canvas id="camera-ingredienti-canvas" width="1280" height="720" style="display:none;"></canvas>
                <button type="button" onclick="scattaFotoIngredienti()" aria-label="Scatta foto" style="position:absolute; bottom:12px; left:50%; transform:translateX(-50%); width:58px; height:58px; border-radius:50%; border:3px solid #fff; background:rgba(255,255,255,0.25); box-shadow:0 0 0 4px rgba(0,0,0,0.35);"></button>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <button type="button" onclick="apriCameraIngredienti()" style="flex:1; padding:8px 12px; font-size:12px; background:#2196F3;">CARICA DA FILE</button>
            </div>
            <input type="file" id="input-foto-ingredienti" accept="image/*" capture="environment" multiple style="display:none;" onchange="gestisciFotoIngredientiCamera(this)">
        </div>

        <div id="lista-foto-ingredienti" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top:10px;"></div>

        <div style="position: relative; min-height: 80px; margin-top: 10px; display:flex; gap:10px; align-items:center; justify-content:center;">
            <select id="select-prodotto-associa" onchange="selezionaProdottoAssocia(this.value)" style="width:240px; padding:6px 14px; font-size:12px; background:#2196F3; color:#fff; border:1px solid #1b6fbf; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.35); appearance:auto;">
                <option value="">ASSOCIA PRODOTTO</option>
            </select>
        </div>

        <button type="button" onclick="convalidaTracciabilitaCamera()" style="position:absolute; right:20px; bottom:20px; padding:6px 12px; font-size:12px; background:#2196F3;">CONVALIDA</button>

        <div id="prodotto-associato-box" style="margin-top:12px; color:#aaa; font-size:12px;">Prodotto: nessuno</div>
    </div>
</section>

<!-- OPERATORE - ARCHIVIO TRACCIABILITA -->
<section id="sez-op-lotti-archivio" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-op-archivi')">‚¨Ö TORNA AL MENU</button>
        <h3>üì¶ ARCHIVIO TRACCIABILITA</h3>
    </div>

    <div class="contenuto" style="max-width: 900px; margin: 0 auto;">
        <div id="lista-lotti-archivio"></div>
    </div>
</section>

<!-- OPERATORE - INGREDIENTI -->
<section id="sez-op-ingredienti" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA AL MENU</button>
        <h2>üßÇ REGISTRO INGREDIENTI</h2>
    </div>

    <div class="card-centrale" style="max-width: 700px;">
        <label class="label-oro" for="nome-ingrediente" style="margin-bottom:3px; font-size:0.85rem;">NOME INGREDIENTE:</label>
        <input type="text" id="nome-ingrediente" placeholder="Es: Farina 00" style="margin-bottom:6px;">

        <label class="label-oro" for="lotto-ingrediente" style="margin-bottom:3px; font-size:0.85rem;">LOTTO:</label>
        <input type="text" id="lotto-ingrediente" placeholder="Es: LOT12345" style="margin-bottom:6px;">

        <label class="label-oro" for="scadenza-ingrediente" style="margin-bottom:3px; font-size:0.85rem;">SCADENZA:</label>
        <input type="date" id="scadenza-ingrediente" style="margin-bottom:6px;">

        <label class="label-oro" for="foto-ingrediente" style="margin-bottom:3px; font-size:0.85rem;">FOTO ETICHETTA:</label>
        <input type="file" id="foto-ingrediente" accept="image/*" capture="environment" style="margin-bottom:6px;" onchange="gestisciFotoIngredienteManuale(this)">
        <div id="preview-foto-ingrediente-manuale" style="margin-bottom:10px;"></div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin-bottom:6px;">
            <button type="button" onclick="salvaIngredienteManuale()" style="padding:10px; background:#4CAF50;">‚úÖ SALVA</button>
            <button type="button" onclick="scansionaIngredienteFoto()" style="padding:10px; background:#2196F3;">üì∑ OCR DA FOTO</button>
        </div>
    </div>

    <div id="lista-ingredienti" style="padding: 20px; max-width: 900px; margin: auto;"></div>
</section>

<!-- OPERATORE - FOTO LOTTI -->
<section id="sez-op-foto-lotti" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-operatore')">‚¨Ö TORNA AL MENU</button>
        <h2>üì∏ ARCHIVIO FOTO LOTTI</h2>
    </div>
    <div id="lista-foto-lotti" style="padding: 20px; max-width: 900px; margin: auto;"></div>
</section>

<!-- MODAL PRODUZIONE -->
<div id="modal-produzione" class="overlay-lotto" style="display:none;">
    <div class="card-centrale modal-sm">
        <button onclick="chiudiModalLotto()" class="modal-close">&times;</button>
        
        <h3 class="modal-title-strong">REGISTRA PRODUZIONE</h3>
        
        <label class="label-oro label-compact" for="select-prodotto-lotto">SCEGLI PRODOTTO:</label>
        <select id="select-prodotto-lotto" onchange="gestisciNuovoProdotto(this.value)"></select>
        
        <label for="nuovo-prodotto-input" class="sr-only">Nuovo prodotto</label>
        <input type="text" id="nuovo-prodotto-input" class="is-hidden" placeholder="Nome nuovo prodotto">

        <label class="label-oro label-compact" for="data-scadenza-lotto">SCADENZA:</label>
        <input type="date" id="data-scadenza-lotto">

        <label class="label-oro label-compact" for="lotto-origine-lotto">LOTTO ORIGINE:</label>
        <input type="text" id="lotto-origine-lotto" placeholder="Lotto fornitore">

        <div class="label-oro label-compact">LOTTI INGREDIENTI:</div>
        <div id="lista-ingredienti-usati" class="modal-box modal-box--compact">
            <p class="modal-muted">Nessun ingrediente aggiunto</p>
        </div>
        <div class="modal-grid-2 modal-grid-compact">
            <button type="button" class="modal-btn modal-btn--auto is-success" onclick="apriModalSelezionaIngredienti()">
                ‚úÖ SELEZIONA
            </button>
            <button type="button" class="modal-btn modal-btn--auto is-primary" onclick="vaiA('sez-op-ingredienti')">
                üì¶ REGISTRO
            </button>
        </div>

        <label class="label-oro label-compact" for="input-foto-lotto-prodotto">FOTO ETICHETTA PRODOTTO:</label>
        <input type="file" id="input-foto-lotto-prodotto" accept="image/*" capture="environment" onchange="processaFotoEtichettaLotto(this)">
        <div id="preview-foto-lotto-prodotto" class="modal-preview"></div>

        <label class="label-oro label-compact" for="note-lotto">NOTE (opzionale):</label>
        <textarea id="note-lotto" class="modal-textarea-compact" placeholder="Note aggiuntive..."></textarea>

        <button type="button" class="modal-btn" onclick="confermaSalvataggioLotto()">SALVA E STAMPA</button>
        <button type="button" class="modal-btn is-secondary" onclick="chiudiModalLotto()">ANNULLA</button>
    </div>
</div>

<!-- MODAL ASSOCIA PRODOTTO -->
<div id="modal-associa-prodotto" class="overlay-lotto" style="display:none;">
    <div class="card-centrale">
        <h3 class="modal-title-strong">ASSOCIA PRODOTTO</h3>
        <label class="label-oro label-compact" for="select-prodotto-associa">PRODOTTO</label>
        <select id="select-prodotto-associa" onchange="selezionaProdottoAssocia(this.value)"></select>

        <label class="label-oro label-compact" for="scadenza-prodotto">SCADENZA (opzionale)</label>
        <input type="date" id="scadenza-prodotto">

        <div class="modal-actions-row">
            <button type="button" class="modal-btn is-success" onclick="confermaAssociaProdotto()">CONFERMA</button>
            <button type="button" class="modal-btn is-secondary" onclick="chiudiModalAssociaProdotto()">ANNULLA</button>
        </div>
    </div>
</div>

<!-- MODAL STAMPA COPIE -->
<div id="modal-stampa-copie" class="overlay-lotto" style="display:none;">
    <div class="card-centrale modal-sm">
        <h3 class="modal-title-strong">STAMPA</h3>
        <label class="label-oro label-compact" for="input-copie-stampa">COPIE (1-30)</label>
        <div class="modal-row modal-body">
            <button type="button" class="modal-stepper-btn" onclick="aggiornaCopieStampa(-1)">-</button>
            <input type="number" id="input-copie-stampa" class="modal-stepper-input" min="1" max="30" value="1">
            <button type="button" class="modal-stepper-btn" onclick="aggiornaCopieStampa(1)">+</button>
        </div>
        <div class="modal-actions-row">
            <button type="button" class="modal-btn is-success" onclick="confermaStampaCopie()">STAMPA</button>
            <button type="button" class="modal-btn is-secondary" onclick="chiudiModalStampaCopie()">ANNULLA</button>
        </div>
    </div>
</div>

<!-- MODAL DETTAGLIO LOTTO -->
<div id="modal-dettaglio-lotto" class="overlay-lotto" style="display:none;">
    <div class="card-centrale">
        <h3 class="modal-title-strong">DETTAGLIO LOTTO</h3>
        <div id="dettaglio-lotto-contenuto" class="modal-body"></div>
        <div class="modal-actions-row">
            <button type="button" class="modal-btn is-success" onclick="stampaLottoDaDettaglio()">STAMPA</button>
            <button type="button" class="modal-btn" onclick="terminaLottoDaDettaglio()">TERMINA</button>
            <button type="button" class="modal-btn is-primary" onclick="cambiaLottoDaDettaglio()">CAMBIA LOTTO</button>
            <button type="button" class="modal-btn is-secondary" onclick="chiudiModalDettaglioLotto()">CHIUDI</button>
        </div>
    </div>
</div>

<!-- MODAL GALLERIA FOTO LOTTO -->
<div id="modal-galleria-lotto" class="overlay-lotto" style="display:none;">
    <div class="card-centrale modal-wide">
        <div class="modal-header-row">
            <h3 class="modal-title-inline">FOTO LOTTO</h3>
            <button type="button" class="modal-btn modal-btn--auto is-secondary" onclick="chiudiGalleriaLotto()">CHIUDI</button>
        </div>
        <div class="galleria-lotto">
            <button type="button" class="galleria-nav" onclick="cambiaFotoLotto(-1)">‚óÄÔ∏é</button>
            <img id="galleria-foto-principale" class="galleria-img" alt="Foto lotto" />
            <button type="button" class="galleria-nav" onclick="cambiaFotoLotto(1)">‚ñ∂Ô∏é</button>
        </div>
        <div id="galleria-thumbs" class="galleria-thumbs"></div>
    </div>
</div>

<!-- MODAL SCANSIONE INGREDIENTE -->
<div id="modal-scansione-ingrediente" class="modal-overlay" style="display:none;">
    <div class="modal-card is-blue">
        <h3 class="modal-title is-blue">üì∑ SCANSIONE INGREDIENTE</h3>
        
        <label for="input-foto-ingrediente-ocr" class="sr-only">Seleziona foto ingrediente</label>
        <input type="file" id="input-foto-ingrediente-ocr" class="is-hidden" accept="image/*" capture="environment" onchange="processaFotoIngrediente(this)">
        
        <div class="modal-actions">
            <button type="button" class="modal-btn is-primary" onclick="document.getElementById('input-foto-ingrediente-ocr').click()">
                üì∏ SCATTA FOTO / CARICA IMMAGINE
            </button>
        </div>
        
        <div id="preview-foto-ingrediente" class="modal-preview"></div>
        
        <div id="risultato-ocr-ingrediente" class="modal-result">
            <p class="modal-placeholder">In attesa di foto...</p>
        </div>
        
        <div id="form-ingrediente-estratto" class="modal-form">
            <label for="nome-ingrediente-ocr" class="modal-label">Nome:</label>
            <input type="text" id="nome-ingrediente-ocr" class="modal-input">

            <label for="lotto-ingrediente-ocr" class="modal-label">Lotto:</label>
            <input type="text" id="lotto-ingrediente-ocr" class="modal-input">

            <label for="scadenza-ingrediente-ocr" class="modal-label">Scadenza:</label>
            <input type="date" id="scadenza-ingrediente-ocr" class="modal-input">
            
            <button type="button" class="modal-btn is-success" onclick="confermaIngredienteScansionato()">
                ‚úÖ SALVA INGREDIENTE
            </button>
        </div>
        
        <button type="button" class="modal-btn is-secondary" onclick="chiudiModalScansioneIngrediente()">
            ‚ùå ANNULLA
        </button>
    </div>
</div>

<!-- OPERATORE - PULIZIE -->
<section id="sez-op-pulizie" class="schermata" style="display:none">
    <div class="header-data">
        <button onclick="vaiA('sez-operatore')" class="btn-mini-back">‚¨Ö MENU</button>
        <h3 style="color: var(--oro); margin: 0;">REGISTRO PULIZIE</h3>
        <div style="width: 80px;"></div>
    </div>

    <div id="pulizie-alert" class="pulizie-alert" style="display:none;"></div>

    <div id="pulizie-riepilogo" class="pulizie-riepilogo" style="display:none;"></div>

    <p style="text-align: center; color: #888; font-size: 0.85rem; margin: 10px 0;">Sanificazione Ambienti</p>

    <div style="display: flex; justify-content: center; align-items: center; gap: 15px; padding: 15px; background: #1a1a1a;">
        <span onclick="cambiaDataPulizie(-1)" style="color: gold; font-size: 1.5rem; cursor: pointer;">‚óÄ</span>
        <b id="data-visualizzata-pulizie" style="color: gold; font-size: 1.2rem;">--/--/----</b>
        <span onclick="cambiaDataPulizie(1)" style="color: gold; font-size: 1.5rem; cursor: pointer;">‚ñ∂</span>
    </div>

    <div id="lista-pulizie-giorno" style="padding: 20px; max-width: 700px; margin: auto;"></div>

    <div style="text-align: center; margin-top: 20px;">
        <button onclick="registraPulizieGiorno()" style="padding: 15px 40px; font-size: 1.1rem;">
            ‚úÖ CONFERMA PULIZIE COMPLETATE
        </button>
    </div>
</section>

<!-- OPERATORE - NON CONFORMIT√Ä -->
<section id="sez-op-nc" class="schermata" style="display:none">
    <div class="header-data">
        <button onclick="vaiA('sez-operatore')" class="btn-mini-back">‚¨Ö MENU</button>
        <h3 style="color: var(--oro); margin: 0;">NON CONFORMIT√Ä</h3>
        <div style="width: 80px;"></div>
    </div>

    <p style="text-align: center; color: #888; font-size: 0.85rem; margin: 10px 0;">Segnalazioni e Azioni Correttive</p>

    <div style="display: flex; gap: 10px; padding: 15px; justify-content: center; background: #1a1a1a;">
        <button id="filtro-aperte" onclick="filtraNC('aperte')" style="flex: 1; max-width: 200px; background: #ff5252;">üî¥ APERTE</button>
        <button id="filtro-chiuse" onclick="filtraNC('chiuse')" style="flex: 1; max-width: 200px; background: #444;">‚úÖ CHIUSE</button>
        <button id="filtro-tutte" onclick="filtraNC('tutte')" style="flex: 1; max-width: 200px; background: #444;">üìã TUTTE</button>
    </div>

    <div id="lista-nc" style="padding: 20px; max-width: 900px; margin: auto;"></div>

    <button class="btn-floating" onclick="apriModalNC()">+</button>
</section>

<!-- MODAL NON CONFORMIT√Ä -->
<div id="modal-nc" class="overlay-lotto" style="display:none;">
    <div class="card-centrale">
        <h3 class="modal-title is-danger">‚ö†Ô∏è SEGNALA NON CONFORMIT√Ä</h3>
        
        <label class="label-oro" for="nc-tipo">TIPO ANOMALIA:</label>
        <select id="nc-tipo">
            <option value="">-- Seleziona --</option>
            <option value="Temperatura Fuori Range">üå°Ô∏è Temperatura Fuori Range</option>
            <option value="Prodotto Scaduto">üìÖ Prodotto Scaduto</option>
            <option value="Merce Non Conforme">üì¶ Merce Non Conforme</option>
            <option value="Igiene Carente">üßπ Igiene Carente</option>
            <option value="Attrezzatura Rotta">üîß Attrezzatura Rotta</option>
            <option value="Contaminazione">‚ò£Ô∏è Contaminazione</option>
            <option value="Altro">‚ùì Altro</option>
        </select>

        <label class="label-oro" for="nc-area">AREA/REPARTO:</label>
        <select id="nc-area">
            <option value="">-- Seleziona --</option>
            <option value="Bancone Vendita">Bancone Vendita</option>
            <option value="Cella Frigo">Cella Frigo</option>
            <option value="Laboratorio">Laboratorio Lavorazione</option>
            <option value="Magazzino">Magazzino</option>
            <option value="Ricevimento Merci">Ricevimento Merci</option>
        </select>

        <label class="label-oro" for="nc-descrizione">DESCRIZIONE DETTAGLIATA:</label>
        <textarea id="nc-descrizione" class="modal-textarea" placeholder="Descrivi cosa √® successo..."></textarea>

        <label class="label-oro" for="nc-gravita">GRAVIT√Ä:</label>
        <select id="nc-gravita">
            <option value="Bassa">üü¢ Bassa</option>
            <option value="Media">üü° Media</option>
            <option value="Alta">üî¥ Alta</option>
        </select>

        <div class="modal-actions-row is-spaced">
            <button class="modal-btn is-danger" onclick="salvaNC()">REGISTRA NC</button>
            <button class="modal-btn is-secondary" onclick="chiudiModalNC()">ANNULLA</button>
        </div>
    </div>
</div>

<!-- MODAL AZIONE CORRETTIVA -->
<div id="modal-azione-correttiva" class="overlay-lotto" style="display:none;">
    <div class="card-centrale">
        <h3 class="modal-title is-success">‚úÖ AZIONE CORRETTIVA</h3>
        
        <input type="hidden" id="nc-id-chiusura">
        
        <label class="label-oro" for="nc-azione">AZIONE INTRAPRESA:</label>
        <textarea id="nc-azione" class="modal-textarea" placeholder="Descrivi cosa hai fatto..."></textarea>

        <label class="label-oro" for="nc-responsabile">RESPONSABILE CHIUSURA:</label>
        <input type="text" id="nc-responsabile" readonly>

        <div class="modal-actions-row is-spaced">
            <button class="modal-btn is-success" onclick="chiudiNC()">CHIUDI NC</button>
            <button class="modal-btn is-secondary" onclick="chiudiModalAzioneCorrettiva()">ANNULLA</button>
        </div>
    </div>
</div>

<!-- STORICO -->
<section id="sez-storico-admin" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA AL MENU</button>
        <h3>STORICO COMPLETO</h3>
    </div>

    <div style="padding: 15px; max-width: 900px; margin: auto;">
        
        <div style="background: #1c1c1f; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <label for="filtro-data-inizio" style="color: var(--oro); font-size: 0.85rem;">Periodo:</label>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="date" id="filtro-data-inizio" style="flex: 1;">
                <input type="date" id="filtro-data-fine" style="flex: 1;">
            </div>
            <button onclick="filtraStorico()" style="margin-top: 10px;">FILTRA DATI</button>
        </div>

        <div style="display: flex; gap: 10px; padding: 10px; justify-content: center; background: #1a1a1a; flex-wrap: wrap;">
            <button onclick="mostraTabStorico('temperature')" id="tab-temp" class="tab-btn" style="flex: 1; min-width: 100px;">üå°Ô∏è TEMP</button>
            <button onclick="mostraTabStorico('lotti')" id="tab-lotti" class="tab-btn" style="flex: 1; min-width: 100px;">üè∑Ô∏è LOTTI</button>
            <button onclick="mostraTabStorico('pulizie')" id="tab-pulizie" class="tab-btn" style="flex: 1; min-width: 100px;">üßπ PULIZIE</button>
            <button onclick="mostraTabStorico('nc')" id="tab-nc" class="tab-btn" style="flex: 1; min-width: 100px;">‚ö†Ô∏è NC</button>
        </div>

        <div id="storico-temperature" class="elenco-dati"></div>
        <div id="storico-lotti" class="elenco-dati" style="display:none;"></div>
        <div id="storico-pulizie" class="elenco-dati" style="display:none;"></div>
        <div id="storico-nc" class="elenco-dati" style="display:none;"></div>

        <button onclick="esportaStoricoCSV()" style="margin-top: 20px; background: #4CAF50;">üíæ SCARICA CSV</button>
    </div>
</section>

<!-- GENERATORE REPORT MENSILE -->
<section id="sez-report-mensile" class="schermata" style="display:none">
    <div class="header-sottopagina">
        <button onclick="vaiA('sez-admin')">‚¨Ö TORNA AL MENU</button>
        <h3>REPORT MENSILE HACCP</h3>
    </div>

    <div style="padding: 20px; max-width: 800px; margin: auto;">
        
        <div class="card-centrale" style="max-width: 500px;">
            <h3 style="color: #2196F3;">üìÑ GENERA REPORT</h3>
            <p style="font-size: 0.9rem; color: #aaa;">Seleziona il mese da esportare per ASL/Audit</p>

            <label class="label-oro" for="mese-report">MESE E ANNO:</label>
            <input type="month" id="mese-report" style="margin-bottom: 20px;">

            <button onclick="generaReportMensile()" style="background: #2196F3; padding: 15px; font-size: 1.1rem;">
                üìä GENERA E VISUALIZZA
            </button>
        </div>

        <div id="anteprima-report" style="display:none; margin-top: 30px; background: white; padding: 30px; border-radius: 12px; color: black;"></div>

        <div id="azioni-report" style="display:none; margin-top: 20px; gap: 15px; justify-content: center;">
            <button onclick="stampaReport()" style="background: #4CAF50; padding: 15px 30px;">üñ®Ô∏è STAMPA</button>
            <button onclick="scaricaReportPDF()" style="background: #f44336; padding: 15px 30px;">üì• PDF</button>
        </div>

    </div>
</section>

<script src="sync-cloud.js"></script>
<script src="app.js"></script>
</body>
</html>